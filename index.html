<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agroweb - Predicciones Agrícolas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      background-image: url('activos/fondo.png');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
    }
    #map { height: 300px; width: 100%; }
    .container { background-color: rgba(255, 255, 255, 0.9); }
  </style>
</head>
<body class="font-sans">
  <div class="container mx-auto p-6">
    <div class="text-center mb-6">
      <img src="activos/ESPOCH.png" alt="Logo ESPOCH" class="mx-auto h-24">
      <h1 class="text-4xl font-bold text-green-800">Agroweb</h1>
      <p class="text-lg text-gray-700">Predicciones Agrícolas - Escuela Superior Politécnica de Chimborazo</p>
      <p class="text-md text-gray-600">Facultad de Mecánica</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md max-w-lg mx-auto">
      <form id="farmForm" onsubmit="handleSubmit(event)">
        <div class="mb-4">
          <label for="crop" class="block text-gray-700">Tipo de Cultivo</label>
          <input type="text" id="crop" class="w-full p-2 border rounded" placeholder="Ej: Maíz, Trigo" required>
        </div>
        <div class="mb-4">
          <label for="size" class="block text-gray-700">Tamaño del Terreno (hectáreas)</label>
          <input type="number" id="size" step="0.1" min="0.1" class="w-full p-2 border rounded" required>
        </div>
        <div class="mb-4">
          <label for="month" class="block text-gray-700">Mes de Siembra</label>
          <select id="month" class="w-full p-2 border rounded" required>
            <option value="">Selecciona un mes</option>
            <option value="Enero">Enero</option>
            <option value="Febrero">Febrero</option>
            <option value="Marzo">Marzo</option>
            <option value="Abril">Abril</option>
            <option value="Mayo">Mayo</option>
            <option value="Junio">Junio</option>
            <option value="Julio">Julio</option>
            <option value="Agosto">Agosto</option>
            <option value="Septiembre">Septiembre</option>
            <option value="Octubre">Octubre</option>
            <option value="Noviembre">Noviembre</option>
            <option value="Diciembre">Diciembre</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="year" class="block text-gray-700">Año de Siembra</label>
          <input type="number" id="year" min="2026" max="2035" class="w-full p-2 border rounded" required>
        </div>
        <div class="mb-4">
          <label for="irrigation" class="block text-gray-700">Tipo de Riego</label>
          <select id="irrigation" class="w-full p-2 border rounded" required>
            <option value="">Selecciona un tipo de riego</option>
            <option value="goteo">Riego por goteo</option>
            <option value="aspersión">Riego por aspersión</option>
            <option value="gravedad">Riego por gravedad</option>
            <option value="manual">Riego manual</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="location" class="block text-gray-700">Ubicación (haz clic en el mapa)</label>
          <input type="text" id="location" class="w-full p-2 border rounded" readonly placeholder="Coordenadas aparecerán aquí">
          <div id="map" class="mt-2"></div>
        </div>
        <button type="submit" class="w-full bg-green-800 text-white p-2 rounded hover:bg-green-700">Obtener Predicciones</button>
      </form>
      <div id="predictions" class="mt-6 hidden">
        <h2 class="text-2xl font-semibold mb-4">Predicciones</h2>
        <div id="predContent" class="text-gray-700"></div>
      </div>
    </div>
  </div>
  <script>
    // Inicializar el mapa con Leaflet
    const map = L.map('map').setView([-1.6636, -78.6546], 8); // Centrado en Chimborazo, Ecuador
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let marker;
    map.on('click', function(e) {
      const lat = e.latlng.lat.toFixed(4);
      const lng = e.latlng.lng.toFixed(4);
      document.getElementById('location').value = `${lat}, ${lng}`;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
    });

    function handleSubmit(event) {
      event.preventDefault();
      const crop = document.getElementById('crop').value.trim().toLowerCase();
      const size = parseFloat(document.getElementById('size').value);
      const month = document.getElementById('month').value;
      const year = parseInt(document.getElementById('year').value);
      const irrigation = document.getElementById('irrigation').value;
      const location = document.getElementById('location').value;

      const predictions = generatePredictions(crop, size, month, year, irrigation, location);
      const predDiv = document.getElementById('predictions');
      const predContent = document.getElementById('predContent');
      predContent.innerHTML = predictions;
      predDiv.classList.remove('hidden');
    }

    function generatePredictions(crop, size, month, year, irrigation, location) {
      let preds = `<p><strong>Cultivo:</strong> ${crop.charAt(0).toUpperCase() + crop.slice(1)}</p>`;
      preds += `<p><strong>Tamaño:</strong> ${size} hectáreas</p>`;
      preds += `<p><strong>Mes y Año:</strong> ${month} ${year}</p>`;
      preds += `<p><strong>Tipo de Riego:</strong> ${irrigation.charAt(0).toUpperCase() + irrigation.slice(1)}</p>`;
      preds += `<p><strong>Ubicación (Coordenadas):</strong> ${location}</p>`;
      preds += '<h3 class="text-xl font-semibold mt-4">Predicciones y Recomendaciones:</h3>';

      // Simulación de datos históricos y tendencias climáticas
      const historicalTrends = {
        'maíz': { optimalTemp: [20, 30], rainfall: [500, 800], riskYears: [2027, 2030] },
        'trigo': { optimalTemp: [15, 25], rainfall: [300, 500], riskYears: [2028, 2031] },
        'arroz': { optimalTemp: [20, 35], rainfall: [1000, 2000], riskYears: [2026, 2029] }
      };
      const cropData = historicalTrends[crop] || { optimalTemp: [15, 30], rainfall: [400, 1000], riskYears: [] };

      // Pronóstico multianual
      const currentYear = new Date().getFullYear(); // 2025
      const yearsToPredict = [year, year + 1, year + 2];
      let multiYearForecast = '<h4 class="text-lg font-medium mt-2">Pronóstico Multianual:</h4><ul>';
      yearsToPredict.forEach(y => {
        const isRiskYear = cropData.riskYears.includes(y);
        multiYearForecast += `<li>${y}: ${isRiskYear ? 'Alto riesgo de bajo rendimiento por condiciones históricas adversas' : 'Condiciones potencialmente favorables'}.</li>`;
      });
      multiYearForecast += '</ul>';

      // Clima estimado basado en mes y altitud (Chimborazo, ~2000-4000 m)
      const warmMonths = ['Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto'];
      const coolMonths = ['Septiembre', 'Octubre', 'Noviembre', 'Diciembre', 'Enero', 'Febrero'];
      let climateNote = '';
      if (warmMonths.includes(month)) {
        climateNote = '<p>- <strong>Clima:</strong> Cálido (15-25°C). Riesgo de sequía si lluvia <500 mm.</p>';
      } else if (coolMonths.includes(month)) {
        climateNote = '<p>- <strong>Clima:</strong> Fresco (10-20°C). Riesgo de heladas en altitudes altas.</p>';
      }

      // Recomendaciones detalladas
      let recommendations = '<h4 class="text-lg font-medium mt-2">Recomendaciones:</h4><ul>';
      recommendations += `<li>${size > 5 ? 'Rotación de cultivos recomendada para >5 ha para preservar el suelo.' : 'Terreno pequeño, ideal para cultivos intensivos.'}</li>`;
      if (irrigation === 'manual') {
        recommendations += '<li>Riego manual limitado; considera sistemas automatizados para >2 ha.</li>';
      } else if (irrigation === 'goteo') {
        recommendations += '<li>Riego por goteo: Usa fertilizantes solubles y revisa emisores semanalmente.</li>';
      } else if (irrigation === 'aspersión') {
        recommendations += '<li>Riego por aspersión: Ajusta aspersores para cubrir uniformemente.</li>';
      } else if (irrigation === 'gravedad') {
        recommendations += '<li>Riego por gravedad: Verifica pendiente adecuada en el terreno.</li>';
      }
      recommendations += `<li>Fertilizantes: Nitrógeno (N) y fósforo (P) para ${crop}; analiza el suelo local.</li>`;
      if (cropData.riskYears.includes(year)) {
        recommendations += `<li><strong>Advertencia:</strong> ${year} tiene historial de condiciones adversas (sequías/excesos). Considera quinoa o papa.</li>`;
      } else {
        recommendations += `<li>Buen año para ${crop} si lluvia está entre ${cropData.rainfall[0]}-${cropData.rainfall[1]} mm.</li>`;
      }
      recommendations += '<li>Usa sensores de humedad y drones para optimizar riego y detectar plagas.</li>';
      recommendations += '</ul>';

      // Integración de Gemini con tu API key
      let geminiResponse = '';
      fetch('https://api.gemini.google.com/v1/models/yield-prediction?key=AIzaSyCAjD0u4CztKbe3v3A-gR-95IoSilp7BhQ', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ crop, size, month, year, irrigation, location })
      })
      .then(response => response.json())
      .then(data => geminiResponse = `<p><strong>Insight de Gemini:</strong> ${data.prediction}</p>`)
      .catch(error => geminiResponse = '<p>Error al consultar Gemini: ${error.message}</p>');
      preds += multiYearForecast + climateNote + recommendations + geminiResponse;

      return preds;
    }
  </script>